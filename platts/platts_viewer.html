<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gasolio</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }

        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 450px;
        }

        /* Login/Register specific styles */
        .auth-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
        }

        .auth-header {
            margin-bottom: 2rem;
        }

        .auth-header h1 {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
            color: #1c1e21;
        }

        .auth-header p {
            color: #606770;
            margin: 0;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #1c1e21;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1877f2;
            box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
        }

        .auth-button {
            width: 100%;
            padding: 0.8rem;
            background-color: #1877f2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: background-color 0.3s;
        }

        .auth-button:hover {
            background-color: #166fe5;
        }

        .auth-button:disabled {
            background-color: #8a8a8a;
            cursor: not-allowed;
        }

        .auth-toggle {
            color: #1877f2;
            text-decoration: none;
            cursor: pointer;
        }

        .auth-toggle:hover {
            text-decoration: underline;
        }

                .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 0.75rem 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .user-email {
            color: #495057;
            font-size: 0.85rem;
            font-weight: 500;
            flex: 1;
        }
        
        .logout-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-left: 1rem;
        }
        
        .logout-button:hover {
            background-color: #5a6268;
        }

        .quote-header {
            text-align: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1rem;
        }

        .quote-header h1 {
            font-size: 1.8rem;
            margin: 0;
            color: #1c1e21;
        }

        .quote-header h2 {
            font-size: 1rem;
            font-weight: normal;
            color: #606770;
            margin: 0.25rem 0 0 0;
        }

        .quote-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .data-point {
            background-color: #f6f8fa;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .data-point .label {
            font-size: 0.9rem;
            color: #606770;
            display: block;
            margin-bottom: 0.5rem;
        }

        .data-point .value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .change.positive {
            color: #31a24c;
        }

        .change.negative {
            color: #fa383e;
        }

        .change.neutral {
            color: #606770;
        }

        .unit {
            font-size: 0.8rem;
            color: #606770;
            margin-left: 0.25rem;
        }

        .result-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #1877f2;
            text-align: center;
        }

        .result-container h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            color: #606770;
            font-weight: normal;
        }

        .final-price-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1877f2;
        }

        .price-unit {
            font-size: 1.2rem;
            color: #606770;
            margin-left: 0.5rem;
        }

        button {
            display: block;
            width: 100%;
            margin-top: 1rem;
            background-color: #1877f2;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #166fe5;
        }

        button:disabled {
            background-color: #8a8a8a;
            cursor: not-allowed;
        }

        .error-message {
            color: #fa383e;
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Login/Register Screen -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-header">
            <h1>Gasolio</h1>
            <p id="auth-subtitle">Accedi per visualizzare i dati di mercato</p>
        </div>

        <form id="auth-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>

            <button type="submit" id="auth-submit" class="auth-button">Accedi</button>
        </form>

        <!-- <p>
            <span id="auth-switch-text">Non hai un account?</span>
            <a href="#" id="auth-toggle" class="auth-toggle">Registrati</a>
        </p> -->

        <div id="auth-error" class="error-message"></div>
    </div>

    <!-- Main Application (shown after login) -->
    <div id="main-app" class="container hidden">
        <div class="user-info">
            <span id="user-email" class="user-email"></span>
            <button id="logout-btn" class="logout-button">Logout</button>
        </div>

        <div class="quote-header">
            <h1>Gasolio</h1>
        </div>

        <div class="quote-details">
            <div class="data-point">
                <span class="label">Prezzo Base Platts</span>
                <span id="base-price" class="value">--</span>
                <span class="unit">€/litro</span>
            </div>
            <div class="data-point">
                <span class="label">Variazione Prezzo</span>
                <span id="price-variation" class="value change neutral">--</span>
                <span class="unit">€cent/litro</span>
            </div>
        </div>

        <div class="result-container">
            <h3>Prezzo Finale</h3>
            <div class="final-price-value">
                <span id="final-price">--</span>
                <span class="price-unit">€/litro</span>
            </div>
        </div>

        <div id="error-message" class="error-message"></div>
        <button id="refresh-btn" disabled>Attendere prego...</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration - Replace with your config
        const firebaseConfig = {
            apiKey: "AIzaSyA2rUtbVrUq68JmnAKJ8J0g1mvNoIg1GHs",
            authDomain: "dmprojectnew.firebaseapp.com",
            projectId: "dmprojectnew",
            storageBucket: "dmprojectnew.firebasestorage.app",
            messagingSenderId: "660509531035",
            appId: "1:660509531035:web:aa5796eda30fb7f39edf3e",
            measurementId: "G-3JKSVVJXSB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // DOM elements
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const authForm = document.getElementById('auth-form');
        const authSubmit = document.getElementById('auth-submit');
        const authToggle = document.getElementById('auth-toggle');
        const authSwitchText = document.getElementById('auth-switch-text');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authError = document.getElementById('auth-error');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');

        let isLoginMode = true;

        // Toggle between login and register
        authToggle.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;

            if (isLoginMode) {
                authSubmit.textContent = 'Accedi';
                authSwitchText.textContent = 'Non hai un account?';
                authToggle.textContent = 'Registrati';
                authSubtitle.textContent = 'Accedi per visualizzare i dati di mercato';
            } else {
                authSubmit.textContent = 'Registrati';
                authSwitchText.textContent = 'Hai già un account?';
                authToggle.textContent = 'Accedi';
                authSubtitle.textContent = 'Crea un nuovo account';
            }

            authError.textContent = '';
        });

        // Handle form submission
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = emailInput.value;
            const password = passwordInput.value;

            authSubmit.disabled = true;
            authSubmit.textContent = isLoginMode ? 'Accesso...' : 'Registrazione...';
            authError.textContent = '';

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let errorMessage = 'Si è verificato un errore. Riprova.';

                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Questo email è già registrato.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'La password deve essere di almeno 6 caratteri.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Utente non trovato.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Password errata.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email non valida.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Troppi tentativi. Riprova più tardi.';
                        break;
                }

                authError.textContent = errorMessage;
            } finally {
                authSubmit.disabled = false;
                authSubmit.textContent = isLoginMode ? 'Accedi' : 'Registrati';
            }
        });

        // Handle logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                userEmailSpan.textContent = user.email;

                // Store the ID token for API requests
                user.getIdToken().then((token) => {
                    window.userToken = token;
                });

                // Clear form
                emailInput.value = '';
                passwordInput.value = '';
                authError.textContent = '';
            } else {
                // User is signed out
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                window.userToken = null;
            }
        });

        // Make auth available globally for the main app functions
        window.firebaseAuth = auth;
    </script>

    <script>
        /**
         * Updates the UI with data received from the server.
         * @param {object} data - The data object from the /api/data endpoint.
         */
        function updateUI(data) {
            const { basePlattsPrice, priceVariationCents, bloombergFinalPrice, lastUpdated } = data;

            // Update base price and variations
            document.getElementById('base-price').textContent = basePlattsPrice || 'N/A';
            document.getElementById('final-price').textContent = bloombergFinalPrice || '--';

            // Update price variation with color coding
            const variationElement = document.getElementById('price-variation');
            if (priceVariationCents) {
                variationElement.textContent = priceVariationCents;
                const variationNumeric = parseFloat(priceVariationCents.replace(',', '.'));
                if (!isNaN(variationNumeric)) {
                    if (variationNumeric > 0) {
                        variationElement.className = 'value change positive';
                    } else if (variationNumeric < 0) {
                        variationElement.className = 'value change negative';
                    } else {
                        variationElement.className = 'value change neutral';
                    }
                }
            } else {
                variationElement.textContent = 'N/A';
                variationElement.className = 'value change neutral';
            }

            // Clear any error messages
            document.getElementById('error-message').textContent = '';
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            console.error('Errore client:', message);
        }

        async function fetchData() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Aggiornamento...';

            const container = document.querySelector('.container');
            container.style.opacity = '0.7';

            try {
                // Include authentication token in the request
                const headers = {};
                if (window.userToken) {
                    headers['Authorization'] = `Bearer ${window.userToken}`;
                }

                const response = await fetch('/api/data', { headers });

                if (response.status === 401) {
                    // Token expired or invalid - sign out
                    if (window.firebaseAuth) {
                        await window.firebaseAuth.signOut();
                    }
                    throw new Error('Sessione scaduta. Accedi nuovamente.');
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server ha risposto con stato ${response.status}`);
                }

                const data = await response.json();
                updateUI(data);

            } catch (error) {
                let errorMessage = error.message;
                if (error.message.toLowerCase().includes('failed to fetch')) {
                    errorMessage = 'Errore di connessione. Riprovare tra qualche minuto.';
                }
                showError(errorMessage);
            } finally {
                container.style.opacity = '1';
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Aggiorna Dati';
            }
        }

        // Event listeners
        document.getElementById('refresh-btn').addEventListener('click', fetchData);

        // Initial load - wait for authentication
        window.addEventListener('load', () => {
            const refreshBtn = document.getElementById('refresh-btn');
            const errorDiv = document.getElementById('error-message');

            // Set up observer to load data once authenticated
            const checkAuth = () => {
                if (window.userToken) {
                    refreshBtn.disabled = true;
                    refreshBtn.textContent = 'Attendere prego...';
                    errorDiv.textContent = 'Connessione ai mercati in corso...';

                    setTimeout(() => {
                        errorDiv.textContent = '';
                        refreshBtn.textContent = 'Aggiorna Dati';
                        refreshBtn.disabled = false;
                    }, 10000); // 10 seconds wait
                } else {
                    // Check again in 1 second
                    setTimeout(checkAuth, 1000);
                }
            };

            checkAuth();
        });
    </script>
</body>

</html>